name: MacOS Build for GNU Emacs

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0,12 * * *"

permissions:
  contents: write

jobs:
  build:
    runs-on: macos-15
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: master
            branch: master
            build_dir: emacs
            tarball: Emacs.tar.xz
            artifact_prefix: Emacs
            extra_configure: ""
          - name: igc
            branch: feature/igc
            build_dir: emacs-igc
            tarball: Emacs-MPS.tar.xz
            artifact_prefix: Emacs-MPS
            extra_configure: "--with-mps"
    env:
      DEPS_CACHE_VERSION: v1
      DEPS_PREFIX: ${{ github.workspace }}/deps
      CFLAGS: -O2 -g0 -flto=thin
    steps:
      - name: Get upstream commit hash
        id: get_commit
        run: |
          COMMIT_HASH=$(git ls-remote https://github.com/emacs-mirror/emacs.git refs/heads/${{ matrix.branch }} | cut -f1)
          echo "commit_hash=${COMMIT_HASH}" >> $GITHUB_OUTPUT
          echo "short_hash=${COMMIT_HASH:0:7}" >> $GITHUB_OUTPUT
          echo "tag=${{ matrix.name }}-${COMMIT_HASH:0:7}" >> $GITHUB_OUTPUT
      - name: Check if release exists
        id: check_release
        uses: actions/github-script@v7
        with:
          script: |
            const tag = "${{ steps.get_commit.outputs.tag }}";
            const { owner, repo } = context.repo;
            try {
              await github.rest.repos.getReleaseByTag({ owner, repo, tag });
              core.setOutput("exists", "true");
            } catch (error) {
              if (error.status === 404) {
                core.setOutput("exists", "false");
                return;
              }
              throw error;
            }
      - name: Uninstall Homebrew
        if: steps.check_release.outputs.exists != 'true'
        run: |
          curl -O https://raw.githubusercontent.com/Homebrew/install/HEAD/uninstall.sh
          sudo chmod +x uninstall.sh
          sudo env NONINTERACTIVE=1 ./uninstall.sh
          sudo rm -rf /opt/homebrew
          export PATH=''
          eval $(/usr/libexec/path_helper -s)
      - name: Add dependency bin to PATH
        if: steps.check_release.outputs.exists != 'true'
        run: echo "${DEPS_PREFIX}/bin" >> $GITHUB_PATH
      - name: Cache dependencies
        if: steps.check_release.outputs.exists != 'true'
        id: cache-deps
        uses: actions/cache@v4
        with:
          path: ${{ env.DEPS_PREFIX }}
          key: deps-${{ runner.os }}-${{ env.DEPS_CACHE_VERSION }}
      - name: Build dependencies
        if: steps.check_release.outputs.exists != 'true' && steps.cache-deps.outputs.cache-hit != 'true'
        run: |
          set -euo pipefail
          export PATH="${DEPS_PREFIX}/bin:${PATH}"
          export PKG_CONFIG_PATH="${DEPS_PREFIX}/lib/pkgconfig:${DEPS_PREFIX}/share/pkgconfig"
          export CPPFLAGS="-I${DEPS_PREFIX}/include"
          export LDFLAGS="-L${DEPS_PREFIX}/lib"
          mkdir -p "${DEPS_PREFIX}"
          curl -LO https://ftpmirror.gnu.org/gnu/m4/m4-1.4.20.tar.gz
          tar -zxf m4-1.4.20.tar.gz && cd m4-1.4.20
          ./configure --prefix="${DEPS_PREFIX}" && make -j4
          make install
          cd ..
          curl -LO https://ftpmirror.gnu.org/gnu/autoconf/autoconf-2.72.tar.gz
          tar -zxf autoconf-2.72.tar.gz && cd autoconf-2.72
          ./configure --prefix="${DEPS_PREFIX}" && make -j4
          make install
          cd ..
          curl -LO https://ftpmirror.gnu.org/gnu/automake/automake-1.18.tar.gz
          tar -zxf automake-1.18.tar.gz && cd automake-1.18
          ./configure --prefix="${DEPS_PREFIX}" && make -j4
          make install
          cd ..
          curl -LO https://ftpmirror.gnu.org/gnu/libtool/libtool-2.5.4.tar.gz
          tar -zxf libtool-2.5.4.tar.gz && cd libtool-2.5.4
          ./configure --prefix="${DEPS_PREFIX}" --disable-shared && make -j4
          make install
          cd ..
          curl -LO https://github.com/pkgconf/pkgconf/archive/refs/tags/pkgconf-2.5.1.tar.gz
          tar -zxf pkgconf-2.5.1.tar.gz && cd pkgconf-pkgconf-2.5.1
          ./autogen.sh && ./configure --prefix="${DEPS_PREFIX}" --disable-shared && make -j4
          make install
          ln -sf "${DEPS_PREFIX}/bin/pkgconf" "${DEPS_PREFIX}/bin/pkg-config"
          cd ..
          curl -LO https://ftpmirror.gnu.org/gnu/texinfo/texinfo-7.2.tar.gz
          tar -zxf texinfo-7.2.tar.gz && cd texinfo-7.2
          ./configure --prefix="${DEPS_PREFIX}" && make -j4
          make install
          cd ..
          curl -LO https://ftpmirror.gnu.org/gnu/libiconv/libiconv-1.18.tar.gz
          tar -zxf libiconv-1.18.tar.gz && cd libiconv-1.18
          ./configure --prefix="${DEPS_PREFIX}" --disable-shared && make -j4
          make install
          cd ..
          curl -LO https://ftpmirror.gnu.org/gnu/libunistring/libunistring-1.4.1.tar.gz
          tar -zxf libunistring-1.4.1.tar.gz && cd libunistring-1.4.1
          ./configure --prefix="${DEPS_PREFIX}" --disable-shared && make -j4
          make install
          cd ..
          curl -LO https://ftpmirror.gnu.org/gnu/gettext/gettext-0.26.tar.gz
          tar -zxf gettext-0.26.tar.gz && cd gettext-0.26
          ./configure --prefix="${DEPS_PREFIX}" --disable-shared && make -j4
          make install
          cd ..
          curl -LO https://ftpmirror.gnu.org/gnu/ncurses/ncurses-6.5.tar.gz
          tar -zxf ncurses-6.5.tar.gz && cd ncurses-6.5
          ./configure --prefix="${DEPS_PREFIX}" --disable-shared && make -j4
          make install
          ln -sf "${DEPS_PREFIX}/include/ncursesw/curses.h" "${DEPS_PREFIX}/include/ncurses.h"
          cd ..
          curl -LO https://github.com/madler/zlib/releases/download/v1.3.1/zlib-1.3.1.tar.gz
          tar -zxf zlib-1.3.1.tar.gz && cd zlib-1.3.1
          ./configure --static --prefix="${DEPS_PREFIX}" && make -j4
          make install
          cd ..
          curl -O https://download.gnome.org/sources/libxml2/2.9/libxml2-2.9.9.tar.xz
          tar -Jxf libxml2-2.9.9.tar.xz && cd libxml2-2.9.9
          ./configure --prefix="${DEPS_PREFIX}" --disable-shared && make -j4
          make install
          cd ..
          curl -LO https://ftpmirror.gnu.org/gnu/gmp/gmp-6.3.0.tar.gz
          tar -zxf gmp-6.3.0.tar.gz && cd gmp-6.3.0
          ./configure --prefix="${DEPS_PREFIX}" --disable-shared && make -j4
          make install
          cd ..
          curl -LO https://ftpmirror.gnu.org/gnu/nettle/nettle-3.10.2.tar.gz
          tar -zxf nettle-3.10.2.tar.gz && cd nettle-3.10.2
          ./configure --prefix="${DEPS_PREFIX}" --disable-shared && make -j4
          make install
          cd ..
          curl -LO https://ftpmirror.gnu.org/gnu/libidn/libidn2-2.3.8.tar.gz
          tar -zxf libidn2-2.3.8.tar.gz && cd libidn2-2.3.8
          ./configure --prefix="${DEPS_PREFIX}" --disable-shared && make -j4
          make install
          cd ..
          curl -O https://www.gnupg.org/ftp/gcrypt/gnutls/v3.8/gnutls-3.8.11.tar.xz
          tar -Jxf gnutls-3.8.11.tar.xz && cd gnutls-3.8.11
          ./configure --prefix="${DEPS_PREFIX}" --disable-shared --with-included-libtasn1 --without-p11-kit && make -j4
          make install
          cd ..
          curl -LO https://github.com/tree-sitter/tree-sitter/archive/refs/tags/v0.25.10.tar.gz
          tar -zxf v0.25.10.tar.gz && cd tree-sitter-0.25.10
          make -j4
          make install PREFIX="${DEPS_PREFIX}"
          find "${DEPS_PREFIX}/lib" -name 'libtree-sitter*.dylib' -delete
          cd ..
          curl -O https://www.sqlite.org/2025/sqlite-autoconf-3510100.tar.gz
          tar -zxf sqlite-autoconf-3510100.tar.gz && cd sqlite-autoconf-3510100
          ./configure --prefix="${DEPS_PREFIX}" --disable-shared && make -j4
          make install
          cd ..
          curl -LO https://ftpmirror.gnu.org/gnu/gzip/gzip-1.14.tar.gz
          tar -zxf gzip-1.14.tar.gz && cd gzip-1.14
          ./configure --prefix="${DEPS_PREFIX}" && make -j4
          make install
          touch "${DEPS_PREFIX}/.built"
      - name: Build Emacs
        if: steps.check_release.outputs.exists != 'true'
        run: |
          set -euo pipefail
          export PATH="${DEPS_PREFIX}/bin:${PATH}"
          export PKG_CONFIG_PATH="${DEPS_PREFIX}/lib/pkgconfig:${DEPS_PREFIX}/share/pkgconfig"
          export CPPFLAGS="-I${DEPS_PREFIX}/include"
          export LDFLAGS="-L${DEPS_PREFIX}/lib"
          git clone --depth 1 -b '${{ matrix.branch }}' https://github.com/emacs-mirror/emacs.git '${{ matrix.build_dir }}'
          cd '${{ matrix.build_dir }}' && sed -i '' '/darwin/ s/lncurses/lncursesw/g' configure.ac
          curl -L -O https://github.com/d12frosted/homebrew-emacs-plus/raw/refs/heads/master/patches/emacs-31/system-appearance.patch
          curl -L -O https://github.com/d12frosted/homebrew-emacs-plus/raw/refs/heads/master/patches/emacs-31/round-undecorated-frame.patch
          patch -f -V none -p1 < system-appearance.patch
          patch -f -V none -p1 < round-undecorated-frame.patch
          ./autogen.sh && ./configure PKG_CONFIG="${DEPS_PREFIX}/bin/pkgconf --static" \
                                      --disable-gc-mark-trace          \
                                      --without-all                    \
                                      --with-compress-install          \
                                      --with-gmp                       \
                                      --with-gnutls                    \
                                      --with-modules                   \
                                      --with-native-image-api          \
                                      --with-ns                        \
                                      --with-small-ja-dic              \
                                      --with-threads                   \
                                      --with-toolkit-scroll-bars       \
                                      --with-tree-sitter               \
                                      --with-xml2                      \
                                      --with-zlib                      \
                                      --with-sqlite3                   \
                                      --prefix="${PWD}/../emacs-install" \
                                      ${{ matrix.extra_configure }}
          make -j4 && make install
          ditto nextstep/Emacs.app Emacs.app
          # Create wrapper script to call Emacs binary
          mkdir -p Emacs.app/Contents/MacOS/bin
          cat > Emacs.app/Contents/MacOS/bin/emacs << 'EOF'
          #!/bin/bash
          exec /Applications/Emacs.app/Contents/MacOS/Emacs "$@"
          EOF
          chmod +x Emacs.app/Contents/MacOS/bin/emacs
          # Replace app icon
          curl -LO https://github.com/jimeh/emacs-liquid-glass-icons/raw/refs/heads/main/Resources/EmacsLG3-Default.icns
          mv EmacsLG3-Default.icns Emacs.app/Contents/Resources/Emacs.icns
          curl -LO https://github.com/jimeh/emacs-liquid-glass-icons/raw/refs/heads/main/Resources/Assets.car
          mv Assets.car Emacs.app/Contents/Resources/Assets.car
          plutil -replace CFBundleIconName -string EmacsLG3 Emacs.app/Contents/Info.plist
          touch Emacs.app
          codesign --force --deep -s - Emacs.app
          echo ARTIFACT_VERSION=$(Emacs.app/Contents/MacOS/Emacs --version | sed -nE 's/^GNU Emacs ([0-9.]+).*/\1/p') >> $GITHUB_ENV
          tar -Jcf '${{ matrix.tarball }}' Emacs.app
      - name: Publish release
        if: steps.check_release.outputs.exists != 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.get_commit.outputs.tag }}
          name: Emacs ${{ matrix.name }} ${{ env.ARTIFACT_VERSION }} (${{ steps.get_commit.outputs.short_hash }})
          body: |
            Upstream: https://github.com/emacs-mirror/emacs/commit/${{ steps.get_commit.outputs.commit_hash }}
            Branch: ${{ matrix.branch }}
            Emacs version: ${{ env.ARTIFACT_VERSION }}
          files: ${{ matrix.build_dir }}/${{ matrix.tarball }}
